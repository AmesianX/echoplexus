<html>
<head>
	<title>Chat</title>
	<link rel="stylesheet" type="text/css" href="/main.css">
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script src="/moment.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script>
		$(document).ready(function () {

			var imageContainer = $("#imageThumbnail").html();
			var messageContainer = $("#chatMessage").html();

			var R = {
				imageURL: /(\b(https?|http):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|].(jpg|png|bmp|gif|svg))/gi,
				URL: /(\b(https?|http):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi
			}; // helpful regexes

			function Session () {
				var nick = "Anonymous";
				return {
					setNick: function(newNickname) {
						nick = newNickname;
					},
					getNick: function() {
						return nick;
					}
				};
			}

			function Scrollback () {
				var buffer = [],
					position = 0;
				return {
					add: function (userInput) {
						buffer.push(userInput);
						position += 1;
					},
					prev: function () {
						if (position > 0) {
							position -= 1;
						}
						return buffer[position];
					},
					next: function () {
						if (position < buffer.length) {
							position += 1;
						}
						return buffer[position];
					},
					reset: function () {
						position = buffer.length;
					}
				};
			}

			var scrollback = new Scrollback();
			var session = new Session();

			function handleChatMessage(msg) {

				msg.nickname = msg.nickname || "Anonymous";

				var images;
				if (images = msg.body.match(R.imageURL)) {
					for (var i = 0, l = images.length; i < l; i++) {
						var href = images[i],
							img = $(imageContainer);
							img.find("a").attr("href", href)
										  .attr("title", "Linked by " + msg.nickname)
								.find("img").attr("src", href);
						$("#linklog h1").after(img);
					}

					msg.body = msg.body.replace(R.imageURL, "").trim(); // remove the URLs
				}

				var hyperlinks = msg.body.match(R.URL);

				// hyperify hyperlinks:
				msg.body = msg.body.replace(R.URL,'<a target="_blank" href="$1">$1</a>');

				if (msg.body.length) {
					var chat = $(messageContainer);
					chat.find(".nick").html(msg.nickname).attr("title", msg.nickname);
					chat.find(".body").html(msg.body);
					chat.find(".time").html("[" + moment().format('hh:mm:ss') + "]");
					chat.attr("data-timestamp", moment().unix() + "000");

					if (msg.type) {
						switch (msg.type) {
							case "SYSTEM":
								chat.find(".nick").addClass("system");
								break;
							default:
								break;
						}
					}
					$("#chatlog").append(chat);
				}
			}


			var socket = io.connect(window.location.href);
			socket.on('connect', function () {
				socket.on('chat', function (msg) {
					handleChatMessage(msg);
					$("#chatlog").scrollTop($("#chatlog")[0].scrollHeight);
				});

				$("#chatinput textarea").on("keydown", function (ev) {
					$this = $(this);
					switch (ev.keyCode) {
						case 13: // enter
							ev.preventDefault();
							var userInput = $this.val();
							var message = {
								body: userInput
							};
							scrollback.add(userInput);
							$this.val("");
							socket.emit('chat', message);
							scrollback.reset();
							break;
						case 38: // up
							$this.val(scrollback.prev());
							break;
						case 40: // down
							$this.val(scrollback.next());
							break;
						case 27: // escape
							scrollback.reset();
							$this.val("");
							break;
						default:
							console.log(ev.keyCode);
							break;
					}

				});
			});
			socket.on('disconnect', function () {
				$("#chatinput textarea").off();
				handleChatMessage({body: "Unexpected d/c from server"});
			});

			$("#chatlog").on("hover", ".chatMessage", function (ev) {
				console.log($(ev.target));
				$(ev.target).attr("title", "sent " + moment($(ev.target).data("timestamp")).fromNow());
			});

			$("#chatinput textarea").focus();
	  });
	</script>
</head>
<body>
	<header>

	</header>
	<section id="main">
		<section id="chatarea">
			<div id="chatlog">

			</div>
			<section id=""></section>
			<div id="linklog">
				<h1>Links</h1>
			</div>
		</section>
		<section id="chatinput">
			<textarea></textarea>
		</section>
	</section>
	<div id="ghetto_templates">
		<div id="chatMessage">
			<div class="chatMessage">
				<div class="time"></div>
				<div class="nick"></div>
				<div class="body"></div>
			</div>
		</div>
		<div id="imageThumbnail">
			<div class="imageThumbnail">
				<a href="" target="_blank">
					<img src="" target="_blank" />
				</a>
			</div>
		</div>
	</div>
</body>
</html>