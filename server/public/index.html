<html>
<head>
	<title>Chat</title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<link rel="stylesheet" type="text/css" href="/main.css">
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script src="/jquery.cookie.js"></script>
	<script src="/moment.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script>
		$(document).ready(function () {

			var imageContainer = $("#imageThumbnail").html();
			var messageContainer = $("#chatMessage").html();

			var fl_obj_template = '<object>' +
                          '<param name="movie" value=""></param>' +   
                          '<param name="allowFullScreen" value="true"></param>' +   
                          '<param name="allowscriptaccess" value="always"></param>' +   
                          '<embed src="" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" width="300" height="200"></embed>' +   
                          '</object>'; 

			var R = {
				imageURL: /(\b(https?|http):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|].(jpg|png|bmp|gif|svg))/gi,
				youtubeURL: /(\b(https?|http):\/\/(www.)*(youtube.com)[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,
				URL: /(\b(https?|http):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,
				commands: {
					nick: /^\/nick/,
					register: /^\/register/,
					identify: /^\/identify/,
					failed_command: /^\//,
				}
			}; // helpful regexes

			if (window.Storage) {
				Storage.prototype.setObj = function(key, obj) {
					return this.setItem(key, JSON.stringify(obj))
				}
				Storage.prototype.getObj = function(key) {
					return JSON.parse(this.getItem(key))
				}
			}

			function Log() {
				var log = [],
					logMax = 200;

				if (window.Storage) {
					var prevLog = window.localStorage.getObj("log");
					if (log.length > 500) {
						window.localStorage.setObj("log", null);
					} else if (prevLog) {
						log = prevLog;
					}

					return {
						add: function (obj) {
							if (obj.log === false) return;
							if (log.length > logMax) {
								log.unshift();
							}
							log.push(obj);
							window.localStorage.setObj("log", log);
						},
						empty: function () {
							return (log.length === 0);
						},
						all: function () {
							return log;
						}
					}
				} else { /// return a fake for those without localStorage
					return {
						add: function () {},
						empty: function () { return true; },
						all: function () {
							return log;
						}
					}
				}
			}

			function Notifications () {
				var hasPermission = 1,
					enabled = false;

				if (window.webkitNotifications) {
 					hasPermission = window.webkitNotifications.checkPermission();
				}
				function notify(user,body) {
					if (!enabled) return;

					if (document.hasFocus()) {

					} else {
						if (hasPermission == 0) { // allowed
							var notification = window.webkitNotifications.createNotification(
								'http://i.stack.imgur.com/dmHl0.png',
								user + " says:",
								body
							);


							notification.show();
							setTimeout(function () {
								notification.cancel();
							}, 5000);
						} else { // not allowed
							// hmm
						}
					}
				}
				function requestNotificationPermission() {
					if (window.webkitNotifications) {
						window.webkitNotifications.requestPermission();
					}
				}

				return {
					notify: notify,
					enable: function () {
						enabled = true;
					},
					request: requestNotificationPermission
				};
			}

			function Autocomplete () {
				var pool = [],
					cur = 0;
				return {
					setPool: function (arr) {
						pool = arr;
					},
					next: function (stub) {
						if (!pool.length) return "";
						stub = stub.toLowerCase();
						var name;
						var candidates = pool.filter(function (element, index, array) {
							return (element.toLowerCase().indexOf(stub) !== -1);
						});

						if (!candidates.length) return "";

						cur += 1;
						cur = cur % candidates.length;
						name = candidates[cur];
						
						return name;
					}
				}
			}

			var autocomplete = new Autocomplete();
			var notifications = new Notifications();
			var uniqueImages = {};

			function Client (initdSocket) {
				var nick = "Anonymous",
					socket = initdSocket;
				return {
					setNick: function(newNickname) {
						nick = newNickname;
						socket.emit("nickname", {
							nickname: newNickname
						});
						$.cookie("nickname", newNickname);
					},
					getNick: function() {
						return nick;
					},
					speak: function (msg) {
						socket.emit('chat', msg);
					}
				};
			}

			function Scrollback () {
				var buffer = [],
					position = 0;
				return {
					add: function (userInput) {
						buffer.push(userInput);
						position += 1;
					},
					prev: function () {
						if (position > 0) {
							position -= 1;
						}
						return buffer[position];
					},
					next: function () {
						if (position < buffer.length) {
							position += 1;
						}
						return buffer[position];
					},
					reset: function () {
						position = buffer.length;
					}
				};
			}

			var scrollback = new Scrollback();

			function handleChatMessage(msg) {

				if (!msg.body) return;
				var body = msg.body;


				if (body.match(R.commands.nick)) {
					body = body.replace(R.commands.nick, "").trim();
					session.setNick(body);
					return;
				} else if (msg.body.match(R.commands.register)) {
					msg.body = msg.body.replace(R.commands.register, "").trim();
					socket.emit('register_nick', {
						password: msg.body
					});
					return;
				} else if (msg.body.match(R.commands.identify)) {
					msg.body = msg.body.replace(R.commands.identify, "").trim();
					socket.emit('identify', {
						password: msg.body
					});
					return;
				} else if (msg.body.match(R.commands.failed_command)) {
					return;
				} else {
					session.speak(msg);
				}
			}

			function makeYoutubeURL(s) {
				var start = s.indexOf("v=") + 2;
				var end = s.indexOf("&", start);
				if (end === -1) {
					end = s.length;
				}
				return "http://youtube.com/v/" + s.substring(start,end);
			}

			function renderChatMessage(msg) {
				var autoload_media = $("#autoload_media").attr("checked");
				var body = msg.body;
				// put image links on the side:
				var images;
				if (autoload_media && (images = body.match(R.imageURL))) {
					for (var i = 0, l = images.length; i < l; i++) {
						var href = images[i],
							img = $(imageContainer);

						if (uniqueImages[href] === undefined) {
							img.find("a").attr("href", href)
										  .attr("title", "Linked by " + msg.nickname)
								.find("img").attr("src", href);
							$("#linklog .body").prepend(img);
							uniqueImages[href] = true;
						}
					}

					body = body.replace(R.imageURL, "").trim(); // remove the URLs
				}

				// put youtube linsk on the side:
				var youtubes;
				if (autoload_media && (youtubes = body.match(R.youtubeURL))) {
					for (var i = 0, l = youtubes.length; i < l; i++) {
						var src = makeYoutubeURL(youtubes[i]),
							yt = $(fl_obj_template);
						if (uniqueImages[src] === undefined) {
							yt.find("embed").attr("src", src)
							  .find("param[name='movie']").attr("src", src);
							$("#linklog .body").prepend(yt);
							uniqueImages[src] = true;
						}
					}
				}

				// put hyperlinks on the side:
				var links;
				if (links = body.match(R.URL)) {
					for (var i = 0, l = links.length; i < l; i++) {
						if (uniqueImages[links[i]] === undefined) {
							$("#linklog .body").prepend("<a href='" + links[i] + "' target='_blank'>" + links[i] + "</a>");
							uniqueImages[links[i]] = true;
						}
					}
				}

				// sanitize the body:
				body = body.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

				// hyperify hyperlinks for the chatlog:
				body = body.replace(R.URL,'<a target="_blank" href="$1">$1</a>');

				if (body.length) {
					var chat = $(messageContainer);
					chat.find(".nick").text(msg.nickname).attr("title", msg.nickname);
					chat.find(".body").html(body);
					chat.find(".time").text("[" + moment(msg.timestamp).format('hh:mm:ss') + "]");
					chat.attr("data-timestamp", msg.timestamp);

					if (msg.type) {
						switch (msg.type) {
							case "SYSTEM":
								chat.find(".nick").addClass("system");
								break;
							default:
								break;
						}
					}
					if (msg.nickname === session.getNick()) {
						chat.find(".nick").addClass('me');
					}
					$("#chatlog").append(chat);
					$("#chatlog").scrollTop($("#chatlog")[0].scrollHeight);
				}

				if (body.toLowerCase().split(" ").indexOf(session.getNick().toLowerCase()) !== -1) {
					notifications.notify(msg.nickname, body.substring(0,50));
					chat.addClass("highlight");
				}
			}


			var log = new Log();
			var socket = io.connect(window.location.href);
			socket.on('connect', function () {
				session = new Client(socket);

				if (!log.empty()) {
					var entries = log.all();
					for (var i = 0, l = entries.length; i < l; i++) {
						renderChatMessage(entries[i]);
					}
				}
				notifications.enable();
				socket.on('chat', function (msg) {
					log.add(msg);
					renderChatMessage(msg);
					$("#chatlog").scrollTop($("#chatlog")[0].scrollHeight);
				});
				socket.on('userlist', function (msg) {
					if (msg.users && msg.users.length) {
						autocomplete.setPool(msg.users.map(function (user) {
							return user.nick;
						}));
						$("#userlist .body").html("");
						for (var i = 0, l = msg.users.length; i < l; i++) {
							var user = $("<div class='user'></div>").text(msg.users[i].	nick);
							if (msg.users[i].identified) {
								user.append("<span class='ident yes'>✓</span>");
							} else {
								user.append("<span class='ident no'>✗</span>");
							}
							$("#userlist .body").append(user);
						}
					}
				});

				if ($.cookie("nickname")) {
					session.setNick($.cookie("nickname"));
				}

				$("#chatinput textarea").on("keydown", function (ev) {
					$this = $(this);
					switch (ev.keyCode) {
						case 13: // enter
							ev.preventDefault();
							var userInput = $this.val();
							scrollback.add(userInput);

							userInput = userInput.split("\n");
							for (var i = 0, l = userInput.length; i < l; i++) {
								handleChatMessage({
									body: userInput[i]
								});
							}
							$this.val("");
							scrollback.reset();
							break;
						case 38: // up
							$this.val(scrollback.prev());
							break;
						case 40: // down
							$this.val(scrollback.next());
							break;
						case 27: // escape
							scrollback.reset();
							$this.val("");
							break;
						case 76: // L
							if (ev.ctrlKey) {
								ev.preventDefault();
								$("#chatlog").html("");
								$("#linklog .body").html("");
							}
							break;
						case 9: // tab key
							ev.preventDefault();
							var text = $(this).val().split(" ");
							var stub = text[text.length - 1];				
							var completion = autocomplete.next(stub);

							console.log(text, stub, completion);

							if (completion !== "") {
								text[text.length - 1] = completion;
							}
							if (text.length === 1) {
								text[0] = text[0] + ", ";
							}

							$(this).val(text.join(" "));
							break;
						default:
							break;
					}

				});
			});
			socket.on('disconnect', function () {
				socket.removeAllListeners('chat'); 
				socket.removeAllListeners('userlist');
				$("#chatinput textarea").off();
				handleChatMessage({body: "Unexpected d/c from server", log: false});
			});

			$("#chatlog").on("hover", ".chatMessage", function (ev) {
				$(this).attr("title", "sent " + moment($(this).data("timestamp")).fromNow());
			});

			$("span.options").on("click", function (ev) {
				$(this).siblings("div.options").toggle();
			});

			$("#chatinput textarea").focus();

			$(window).on("click", function () {
				notifications.request();
			});

	  });
	</script>
</head>
<body>
	<header>

	</header>
	<section id="main">
		<section id="chatarea">
			<div id="chatlog">

			</div>
			<div id="supportbar">
				<div id="userlist">
					<div class="header">
						<h1>Users</h1>
					</div>
					<div class="body">

					</div>
				</div>
				<div id="linklog">
					<div class="header">
						<h1>Media & Links</h1>
						<span id="linklog-options" class="options">options</span>
						<div class="options">
							<div class="option">
								<input checked id="autoload_media" type="checkbox" />
								<label for="autoload_media">Autoload Media</label>
							</div>
						</div>
					</div>
					<div class="body">

					</div>
				</div>
			</div>
		</section>
		<section id="chatinput">
			<textarea></textarea>
		</section>
	</section>
	<div id="ghetto_templates">
		<div id="chatMessage">
			<div class="chatMessage">
				<div class="time"></div>
				<div class="nick"></div>
				<div class="body"></div>
			</div>
		</div>
		<div id="imageThumbnail">
			<div class="imageThumbnail">
				<a href="" target="_blank">
					<img src="" target="_blank" />
				</a>
			</div>
		</div>
	</div>
</body>
</html>