<html>
<head>
	<title>Chat</title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<link rel="stylesheet" type="text/css" href="/main.css">
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script src="/jquery.cookie.js"></script>
	<script src="/moment.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script>
		$(document).ready(function () {

			var imageContainer = $("#imageThumbnail").html();
			var messageContainer = $("#chatMessage").html();

			var fl_obj_template = '<object>' +
                          '<param name="movie" value=""></param>' +   
                          '<param name="allowFullScreen" value="true"></param>' +   
                          '<param name="allowscriptaccess" value="always"></param>' +   
                          '<embed src="" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" width="300" height="200"></embed>' +   
                          '</object>'; 

			var R = {
				imageURL: /(\b(https?|http):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|].(jpg|png|bmp|gif|svg))/gi,
				youtubeURL: /(\b(https?|http):\/\/(www.)*(youtube.com)[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,
				URL: /(\b(https?|http):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,
				commands: {
					nick: /^\/nick/
				}
			}; // helpful regexes

			function Client (initdSocket) {
				var nick = "Anonymous",
					socket = initdSocket;
				return {
					setNick: function(newNickname) {
						nick = newNickname;
						socket.emit("nickname", {
							nickname: newNickname
						});
						$.cookie("nickname", newNickname);
					},
					getNick: function() {
						return nick;
					},
					speak: function (msg) {
						socket.emit('chat', msg);
					}
				};
			}

			function Scrollback () {
				var buffer = [],
					position = 0;
				return {
					add: function (userInput) {
						buffer.push(userInput);
						position += 1;
					},
					prev: function () {
						if (position > 0) {
							position -= 1;
						}
						return buffer[position];
					},
					next: function () {
						if (position < buffer.length) {
							position += 1;
						}
						return buffer[position];
					},
					reset: function () {
						position = buffer.length;
					}
				};
			}

			var scrollback = new Scrollback();

			function handleChatMessage(msg) {

				if (!msg.body) return;

				if (msg.body.match(R.commands.nick)) {
					msg.body = msg.body.replace(R.commands.nick, "").trim();
					session.setNick(msg.body);
					return;
				} else {
					session.speak(msg);
				}
				msg.nickname = session.getNick();

				renderChatMessage(msg);
			}

			function makeYoutubeURL(s) {
				var start = s.indexOf("v=") + 2;
				var end = s.indexOf("&", start);
				if (end === -1) {
					end = s.length;
				}
				console.log(s, start, end);
				return "http://youtube.com/v/" + s.substring(start,end);
			}

			function renderChatMessage(msg) {
				// put image links on the side:
				var images;
				if (images = msg.body.match(R.imageURL)) {
					for (var i = 0, l = images.length; i < l; i++) {
						var href = images[i],
							img = $(imageContainer);
							img.find("a").attr("href", href)
										  .attr("title", "Linked by " + msg.nickname)
								.find("img").attr("src", href);
						$("#linklog .body").prepend(img);
					}

					msg.body = msg.body.replace(R.imageURL, "").trim(); // remove the URLs
				}

				// put youtube linsk on the side:
				var youtubes;
				if (youtubes = msg.body.match(R.youtubeURL)) {
					for (var i = 0, l = youtubes.length; i < l; i++) {
						var src = makeYoutubeURL(youtubes[i]),
							yt = $(fl_obj_template);
							yt.find("embed").attr("src", src)
							  .find("param[name='movie']").attr("src", src);
						$("#linklog .body").prepend(yt);
					}
				}

				// put hyperlinks on the side:
				var links;
				if (links = msg.body.match(R.URL)) {
					for (var i = 0, l = links.length; i < l; i++) {
						$("#linklog .body").prepend("<a href='" + links[i] + "' target='_blank'>" + links[i] + "</a>");
					}
				}

				// sanitize the body:
				msg.body = msg.body.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

				// hyperify hyperlinks for the chatlog:
				msg.body = msg.body.replace(R.URL,'<a target="_blank" href="$1">$1</a>');

				if (msg.body.length) {
					var chat = $(messageContainer);
					chat.find(".nick").text(msg.nickname).attr("title", msg.nickname);
					chat.find(".body").html(msg.body);
					chat.find(".time").text("[" + moment().format('hh:mm:ss') + "]");
					chat.attr("data-timestamp", moment().unix() + "000");

					if (msg.type) {
						switch (msg.type) {
							case "SYSTEM":
								chat.find(".nick").addClass("system");
								break;
							default:
								break;
						}
					}
					$("#chatlog").append(chat);
					$("#chatlog").scrollTop($("#chatlog")[0].scrollHeight);
				}
			}


			var socket = io.connect(window.location.href);
			console.log(socket);
			socket.on('connect', function () {
				session = new Client(socket);
				socket.on('chat', function (msg) {
					renderChatMessage(msg);
					$("#chatlog").scrollTop($("#chatlog")[0].scrollHeight);
				});
				socket.on('userlist', function (msg) {
					console.log(msg);
					if (msg.users && msg.users.length) {
						$("#userlist .body").html("");
						for (var i = 0, l = msg.users.length; i < l; i++) {
							$("#userlist .body").append("<div class='user'>").text(msg.users[i]);
						}
					}
				});

				if ($.cookie("nickname")) {
					session.setNick($.cookie("nickname"));
				}

				$("#chatinput textarea").on("keydown", function (ev) {
					$this = $(this);
					switch (ev.keyCode) {
						case 13: // enter
							ev.preventDefault();
							var userInput = $this.val();
							var message = {
								body: userInput
							};
							scrollback.add(userInput);
							handleChatMessage(message);
							$this.val("");
							scrollback.reset();
							break;
						case 38: // up
							$this.val(scrollback.prev());
							break;
						case 40: // down
							$this.val(scrollback.next());
							break;
						case 27: // escape
							scrollback.reset();
							$this.val("");
							break;
						case 76:
							if (ev.ctrlKey) {
								ev.preventDefault();
								$("#chatlog").html("");
								$("#linklog .imageThumbnail").remove();
							}
							break;
						default:
							console.log(ev, ev.keyCode);
							break;
					}

				});
			});
			socket.on('disconnect', function () {
				// socket.removeAllListeners('chat'); 
				// socket.removeAllListeners('userlist');
				$("#chatinput textarea").off();
				handleChatMessage({body: "Unexpected d/c from server"});
			});

			$("#chatlog").on("hover", ".chatMessage", function (ev) {
				$(ev.target).attr("title", "sent " + moment($(ev.target).data("timestamp")).fromNow());
			});

			$("#chatinput textarea").focus();
	  });
	</script>
</head>
<body>
	<header>

	</header>
	<section id="main">
		<section id="chatarea">
			<div id="chatlog">

			</div>
			<section id=""></section>
			<div id="supportbar">
				<div id="userlist">
					<div class="header">
						<h1>Users</h1>
					</div>
					<div class="body">

					</div>
				</div>
				<div id="linklog">
					<div class="header">
						<h1>Media & Links</h1>
					</div>
					<div class="body">

					</div>
				</div>
			</div>
		</section>
		<section id="chatinput">
			<textarea></textarea>
		</section>
	</section>
	<div id="ghetto_templates">
		<div id="chatMessage">
			<div class="chatMessage">
				<div class="time"></div>
				<div class="nick"></div>
				<div class="body"></div>
			</div>
		</div>
		<div id="imageThumbnail">
			<div class="imageThumbnail">
				<a href="" target="_blank">
					<img src="" target="_blank" />
				</a>
			</div>
		</div>
	</div>
</body>
</html>